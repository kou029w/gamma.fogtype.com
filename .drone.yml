# yaml-language-server: $schema=https://json.schemastore.org/drone.json
name: deploy
kind: pipeline
type: docker
node:
  instance: system
trigger:
  event:
    - push
  branch:
    - main
steps:
  - name: deploy
    image: docker:23.0.1-cli-alpine3.17@sha256:6ea6ac10351a3f4670424cff8f43272bbc7e221a5692fc6ff1c46b3b717a09eb
    volumes:
      - name: docker_sock
        path: /var/run/docker.sock
    commands:
      - echo -n "$${ENV}" > .env
      - docker compose --project-name=gammafogtypecom up --detach
      - docker image prune --all --filter=until=24h --force
    environment:
      ENV:
        from_secret: ENV
volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock
---
name: renovate
kind: pipeline
type: docker
clone:
  disable: true
trigger:
  event:
    - cron
  cron:
    - renovate
steps:
  - name: renovate
    image: renovate/renovate:34.129.0@sha256:ee31204a600d5f6a881e6800f6c3f4468e43f9b6c0df782183dd9e0397b2cccd
    commands:
      - renovate
    environment:
      RENOVATE_PLATFORM: gitea
      RENOVATE_ENDPOINT: https://git.fogtype.com/api/v1/
      RENOVATE_AUTODISCOVER: "true"
      RENOVATE_AUTODISCOVER_FILTER: "nebel/!(archive.fogtype.com)"
      RENOVATE_TOKEN:
        from_secret: RENOVATE_TOKEN
